#!/bin/bash

echo "
----------- Commence Operation ---------------
"

# Clone from bakkeby flexi repos
repos_url=(
  "https://github.com/bakkeby/dwm-flexipatch"
  "https://github.com/bakkeby/dmenu-flexipatch"
  "https://github.com/bakkeby/st-flexipatch"
  "https://github.com/bakkeby/flexipatch-finalizer"
)

for repo in ${repos_url[@]};
do
  dir_name=$(basename "$repo")
  dir_path=$(find "$HOME" -type d -name "$dir_name")

  # For easier navigation
  suck_flex="$HOME/suckless-flexipatch/"
  if [[ ! -d "$suck_flex" ]]; then
    mkdir -p "$suck_flex" 2>/dev/null
  fi

  # Check the existence of the flexipatch directory
  if [[ ! -d "$dir_path" ]]; then
    echo "The $dir_name is nowhere to be found, cloning the repo now..."
    git clone "$repo" "$suck_flex/$dir_name" 2>/dev/null
  else
    echo "Found $dir_name at: $dir_path, moving to $suck_flex"
    mv "$dir_path" "$suck_flex/$dir_name"
  fi
done

## 0 = disable, 1 = enable; For convenience.
## Change the status on each "sed" command for reverse operation
status=( "0" "1" )
current_dir="$PWD"

dwm_patches() {
  echo "
------------ Patching out DWM ----------------
  "

  local patches=(
    ## Add the patches that you want
    "ALWAYSCENTER_PATCH"
    "ATTACHBELOW_PATCH"
    "BAR_AWESOMEBAR_PATCH"
    "BAR_FANCYBAR_PATCH"
    "BAR_HEIGHT_PATCH"
    "BAR_LTSYMBOL_PATCH"
    "BAR_STATUS_PATCH"
    "BAR_SYSTRAY_PATCH"
    "BAR_TAGS_PATCH"
    "NO_TRANSPARENT_BORDERS_PATCH"
    "PERTAG_PATCH"
    "PERTAG_VANITYGAPS_PATCH"
    "VANITYGAPS_MONOCLE_PATCH"
    "VANITYGAPS_PATCH"
  )
  local ex_patches=( "BAR_PADDING_VANITYGAPS_PATCH" )
  local dwm_dir=$(find $HOME -type d -name "dwm-flexipatch")

  for patch in ${patches[@]};
  do
    sed -i "s/$patch ${status[0]}/$patch ${status[1]}/g" "$dwm_dir/patches.def.h"
  done

  ## For some reason, it turn on by itself. I don't like having a padding on status bar
  for ex_patch in ${ex_patches[@]}
  do
    sed -i "s/$ex_patch ${status[1]}/$ex_patch ${status[0]}/g" "$dwm_dir/patches.def.h"
  done

  cd "$dwm_dir"; sudo make clean install; cd "$current_dir"
}

st_patches() {
  echo "
-------------- Patching out ST ----------------
  "

  local patches=(
    "ALPHA_PATCH"
    "BOLD_IS_NOT_BRIGHT_PATCH"
    "SCROLLBACK_PATCH"
    "SINGLE_DRAWABLE_BUFFER_PATCH"
    "W3M_PATCH"
    "WIDE_GLYPHS_PATCH"
  )

  local st_dir=$(find $HOME -type d -name "st-flexipatch")
  for patch in ${patches[@]};
  do
    sed -i "s/$patch ${status[0]}/$patch ${status[1]}/g" "$st_dir/patches.def.h"
  done

  cd "$st_dir"; sudo make clean install; cd "$current_dir"
}

dwm_patches
st_patches

echo "
--------------- Operation
 Please re-login from your current dwm session
               Successfull! -------------------
"
### Future implementation
#dwm_configs() {
#  local configs=(
#    "static const unsigned int gappih         = 10;"
#    "static const unsigned int gappiv         = 10;"
#    "static const unsigned int gappoh         = 10;"
#    "static const unsigned int gappov         = 10;"
#    "static const int bar_height              = 20;"
#    "[DEFAULT_TAGS]        = { \"一\", \"二\", \"三\", \"四\", \"五\", \"六\", \"七\", \"八\", \"九\" };"
#    "static const char *fonts[]              = { \"Hack Nerd Font:size=10:style=Regular\" };"
#    "static const char dmenufont[]           = \"Hack Nerd Font:size=10:style=Regular\";"
#  )
#}
