#!/bin/bash
set -e

# Exclusive to arch
FAMILY=("arch" "artix" "endeavouros" "manjaro" "garuda")
DISTRO=$(grep '^ID=' /etc/os-release | cut -d'=' -f2 | tr -d '"')

if [[ ! ${FAMILY[@]} =~ $DISTRO ]]; then
  echo "Sorry, Arch Linux only"
  exit
fi

git_Clone() {
  local url="$1"
  local clone_dir="$2"
  local name=$(basename "$url")

  if ! git clone "${url}" "${clone_dir}" &>/dev/null; then
    echo "Failed to clone $NAME, please check your internet connection" 
    exit
  fi
}

# Check if yay is installed
if ! command -v yay &>/dev/null; then
  local DIR="/tmp/yay"
  git_Clone https://aur.archlinux.org/yay.git "${DIR}"

  pushd "${DIR}"
  makepkg -si
  popd
  rm -rf "${DIR}"
fi

operation_With() {
  local flag="$1"
  shift
  local list=("$@")

  case $flag in
    "-y") local installWith="yay" ;;
    "-p") local installWith="pacman" ;;
  esac

  for package in "${list[@]}"; do
    # Check if the package is already installed
    if $installWith -Q "${package}" &>/dev/null; then
      continue
    fi

    # Don't use sudo on yay
    case $installWith in
      "yay") $installWith -S --noconfirm "${package}";;
      "pacman") sudo $installWith -S --noconfirm "${package}";;
    esac
  done
}

PackagesHyprland() {
  local list_pacman=(
    "grim"
    "hyprland"
    "libnotify"
    "slurp"
    "swappy"
    "swaybg"
    "swaync"
    "waybar"
    "wl-clipboard"
    "wofi"
  )

  operation_With -p "${list_pacman[@]}"
}

PackagesFont() {
  local list_yay=(
    "nerd-fonts"
    "noto-fonts-cjk" 
    "noto-fonts-emoji" 
    "ttf-font-awesome"
    "ttf-hack-nerd"
    "ttf-icomoon-feather"
    "ttf-iosevka-nerd"
    "ttf-jetbrains-mono-nerd"
  )

  operation_With -y "${list_yay[@]}"
}

PackagesEssential() {
  local list_pacman=(
    "brightnessctl"
    "fzf"
    "lazygit"
    "man"
    "npm"
    "pacman-contrib"
    "pipewire"
    "pipewire-pulse"
    "pwvucontrol"
    "ripgrep"
    "thunar"
    "tmux"
    "udiskie"
    "udisks2"
    "unzip"
    "wireplumber"
  )

  local list_yay=(
    "anki-bin"
    "kwindowsystem"
    "python-pywal16"
    "wl-color-picker"
    "zen-browser-bin"
  )

  operation_With -p "${list_pacman[@]}"
  operation_With -y "${list_yay[@]}"

  local DIR="$HOME/.config/nvim/"
  if [[ -z "$(ls -A "${DIR}")" ]]; then
    git_Clone https://github.com/MuteSTEVE/nvim.git "${DIR}"
  fi
}

PackagesJapanese() {
  local list_pacman=(
    "fcitx5"
    "fcitx5-configtool"
    "fcitx5-mozc"
    "ffmpeg"
    "mpv"
    "ocrfeeder"
    "tesseract"
    "tesseract-data-chi_sim"
    "tesseract-data-chi_sim_vert"
    "tesseract-data-chi_tra"
    "tesseract-data-chi_tra_vert"
    "tesseract-data-jpn"
    "tesseract-data-jpn_vert"
  )

  operation_With -p "${list_pacman[@]}"

  local DIR=$HOME/.config/mpv/scripts/
  if [[ -z "$(ls -A "${DIR}")" ]]; then
    mkdir -p "$DIR"
    git_Clone 'https://github.com/Ajatt-Tools/mpvacious.git' "${DIR}/subs2srs"
  fi
}

## To be copied
ConfigDirectories() {
  local list=(
    ".bashrc"
    ".gitconfig"
    ".config/"
    ".local/"
  )

  for copy in "${list[@]}"; do
    cp -rn "$PWD/${copy}" $HOME/
  done
  chmod +x $HOME/.local/bin/*
}

## Wallpaper from wallhaven.cc
DownloadWallpapers() {
  WALLS=(
    "https://w.wallhaven.cc/full/8o/wallhaven-8opwv2.png" # Blue Archive - Arisu
    "https://w.wallhaven.cc/full/5g/wallhaven-5gyjw3.jpg" # Blue Archive - Arisu
    "https://w.wallhaven.cc/full/1k/wallhaven-1klez3.png" # Blue Archive - Izuna
    "https://w.wallhaven.cc/full/d6/wallhaven-d62oog.png" # Blue Archive - Izuna
    "https://w.wallhaven.cc/full/p9/wallhaven-p9gzvm.jpg" # Blue Archive - Izuna
    "https://w.wallhaven.cc/full/2y/wallhaven-2yxpy6.jpg" # Blue Archive - Koyuki
    "https://w.wallhaven.cc/full/rr/wallhaven-rrep8j.jpg" # Blue Archive - Momoi
    "https://w.wallhaven.cc/full/p9/wallhaven-p9xqpm.jpg" # Blue Archive - Momoi & Midori
    "https://w.wallhaven.cc/full/we/wallhaven-wel3l7.jpg" # Blue Archive - Momoi & Midori
    "https://w.wallhaven.cc/full/9d/wallhaven-9dwr8x.png" # Blue Archive - Mutsuki
    "https://w.wallhaven.cc/full/zy/wallhaven-zyrmpg.png" # Blue Archive - Mutsuki
    "https://w.wallhaven.cc/full/gp/wallhaven-gp2xol.png" # Blue Archive - Mutsuki
  )

  local DIR=$HOME/.local/wallpapers/
  if [[ -z "$(ls -A "${DIR}")" ]]; then
    mkdir -p "$DIR"
    for img in "${WALLS[@]}"; do
      curl -O --output-dir "$DIR" "${img}"
    done
  fi
}

main() {
  ConfigDirectories
  DownloadWallpapers
  PackagesEssential
  PackagesFont
  PackagesHyprland
  PackagesJapanese
}
main
